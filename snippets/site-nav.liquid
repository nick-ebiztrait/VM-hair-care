<ul class="site-nav list--inline {{ nav_alignment }}" id="SiteNav">
  {% for link in linklists[section.settings.main_linklist].links %}
    {% comment %}
      Check if third-level nav exists on each parent link.
    {% endcomment %}
    {%- assign three_level_nav = false -%}
    {%- assign child_list_handle = link.title | handleize -%}

    {% if linklists[child_list_handle].links != blank %}
      {% for childlink in linklists[child_list_handle].links %}
        {% assign grand_child_list_handle = childlink.title | handleize %}
        {% if linklists[grand_child_list_handle].links != blank %}
          {%- assign three_level_nav = true -%}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if section.settings.mega_enable and link.title == section.settings.megadropdown_link %}
      <li class="dropdown mega-drop site-nav--has-dropdown"> 
        <a href="{{ link.url }}" class="site-nav__link site-nav__link--main">
              {{ link.title }}
              {% include 'icon-chevron-down' %}
              <span class="visually-hidden">{{ 'layout.navigation.expand' | t }}</span>
        </a>
         <div class="site-nav__dropdown{% if three_level_nav %} site-nav__dropdown--centered{% endif %}" id="SiteNavLabel-{{ child_list_handle }}" aria-expanded="false">
          <ul class="megamenu grid">
            <div class="grid__item one-whole">      
              {% case section.blocks.size %}
              {% when 0 %}
              {% when 1 %}
              {% assign column_width = 'one-whole' %}
              {% when 2 %}
              {% assign column_width = 'one-half' %}
              {% when 3 %}
              {% assign column_width = 'one-third' %}
              {% when 4 %}
              {% assign column_width = 'one-quarter' %}
              {% when 5 %}
              {% assign column_width = 'one-fifth' %}
              {% endcase %}  

              {% for block in section.blocks %} 
             
                {% if block.type == 'image' %}
                  {%- assign image_size = '600x' -%}
              		<li class="grid__item {{ column_width }} mm-image">
					  {% if block.settings.title != blank %}
                      	<h4>{{ block.settings.title }}</h4>
                      {% endif %}
                      <a href="{{ block.settings.nav_promo_link }}">
                        <img src="{{ block.settings.nav_promo_image | img_url: image_size }}">
                      </a>
                    </li>
              
                {% elsif block.type == 'menu' %}
              
                   <li class="grid__item {{ column_width }}">
                      {% if block.settings.title != blank %}
                      	<h4>{{ block.settings.title }}</h4>
                      {% endif %}
                      <ul class="mega-stack" {{ block.shopify_attributes }}>
                        {% for link in linklists[block.settings.mega-nav].links %}
                        <li>{{ link.title | link_to: link.url }}</li>
                        {% endfor %}
                      </ul>
                    </li>
              
                {% endif %}

              {% endfor %} 
            </div>
          </ul>
        </div>
      </li>
  
    {% elsif linklists[child_list_handle].links != blank %}
      <li class="site-nav--has-dropdown{% if three_level_nav %} site-nav--has-centered-dropdown{% endif %}{% if link.active %} site-nav--active{% endif %}" aria-has-popup="true" aria-controls="SiteNavLabel-{{ child_list_handle }}">
        <a href="{{ link.url }}" class="site-nav__link site-nav__link--main">
          {{ link.title }}
          {% include 'icon-chevron-down' %}
          <span class="visually-hidden">{{ 'layout.navigation.expand' | t }}</span>
        </a>

        <div class="site-nav__dropdown{% if three_level_nav %} site-nav__dropdown--centered{% endif %}" id="SiteNavLabel-{{ child_list_handle }}" aria-expanded="false">
          {% if three_level_nav %}
            <div class="site-nav__childlist">
              <div class="site-nav__childlist-grid">
                {% if linklists[child_list_handle].links != blank %}
                  {% for childlink in linklists[child_list_handle].links %}
                    {% assign grand_child_list_handle = childlink.title | handle %}

                    <div class="site-nav__childlist-item">
                      <a href="{{ childlink.url }}" class="site-nav__link site-nav__child-link site-nav__child-link--parent">{{ childlink.title | escape }}</a>
                      {% for grandchildlink in linklists[grand_child_list_handle].links %}
                        <ul>
                          <li>
                            <a href="{{ grandchildlink.url }}" class="site-nav__link site-nav__child-link">{{ grandchildlink.title | escape }}</a>
                          </li>
                        </ul>
                      {% endfor %}
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          {% else %}
            <ul>
              {% for childlink in linklists[child_list_handle].links %}
                <li {% if childlink.active %}class="site-nav--active"{% endif %}>
                  <a href="{{ childlink.url }}" class="site-nav__link site-nav__child-link{% if forloop.last %} site-nav__link--last{% endif %}">{{ childlink.title | escape }}</a>
                </li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </li>
    {% else %}
      <li {% if link.active %}class="site-nav--active"{% endif %}>
        <a href="{{ link.url }}" class="site-nav__link site-nav__link--main">{{ link.title }}</a>
      </li>
    {% endif %}
  {% endfor %}
</ul>
